#!/bin/bash
################################################################
# John Weigand (3/5/12)
#
# Gratia Collector Tomcat configuration.
################################################################
function logit {
  echo "$1"
}
#---------------
function logerr {
  logit "ERROR: $1";exit 1
}
#---------------
function verify_root {
  if [ "`id -u`" != "0" ];then
    logerr "You must be root to execute this."
  fi
}
#---------------
function runit {
  local cmd="$1"
  logit "... executing: $cmd"
  $cmd;rtn=$?
  if [ "$rtn" != "0" ];then
    logerr "process failed: $cmd"
  fi
}
#---------------
function find_tomcat_version {
  [ ! -z "$TOMCAT_VERSION" ] && return  # already have it
  if [ -r "/etc/tomcat5/tomcat5.conf" ];then
    export TOMCAT_VERSION=tomcat5    
  elif [ -r "/etc/tomcat6/tomcat6.conf" ];then
    export TOMCAT_VERSION=tomcat6    
  else
    logerr "Unable to determine tomcat version"
  fi
}
#---------------
function configuring_tomcat {
  logit "--- Configuring Tomcat and server.xml ---"
  script="/var/lib/trustmanager-tomcat/configure.sh"
  if [ ! -x "$script" ];then
    logerr "Configuration file does not exist or is not executable: $script"
  fi
  runit "/var/lib/trustmanager-tomcat/configure.sh"
  logit
}
#---------------
function update_tomcat_conf {
  find_tomcat_version 
  logit "--- Updating ${TOMCAT_VERSION}.conf ---"
  cfg=/usr/share/${TOMCAT_VERSION}/conf/${TOMCAT_VERSION}.conf
  if [ ! -f $cfg ];then
    logerr "tomcat config file does not exist: $cfg"
  fi
  runit "cp -p $cfg ${cfg}.${BACKUP_DATE}"
  cat >>$cfg <<EOF
JAVA_OPTS=' -server -Xmx1024M -XX:MaxPermSize=256m -Dcom.mchange.v2.c3p0.management.ManagementCoordinator=com.mchange.v2.c3p0.management.NullManagementCoordinator -Dcom.sun.management.jmxremote'
EOF
  logit
}
#----------------
function update_server_xml {
  find_tomcat_version 
  logit "--- Updating server.xml ---"
  server_xml=/usr/share/${TOMCAT_VERSION}/conf/server.xml
  logit "Replacing Tomcat server.xml file: $server_xml"
  runit "cp -p $server_xml ${server_xml}.${BACKUP_DATE}"
  runit "cp -p $SERVER_XML_TEMPLATE $server_xml"
  runit "chmod 644         $server_xml"
  runit "chown tomcat.root $server_xml"
  logit
}
#---------------
function handle_logging {
  find_tomcat_version 
  case "$TOMCAT_VERSION" in 
      "tomcat5" )  
	logit "--- addining gratia classes to common/classes ---"
        runit "cd /usr/share/tomcat5/common/classes"
        runit "jar xvf /usr/share/tomcat5/webapps/gratia-services/WEB-INF/lib/gratia-util.jar net/sf/gratia/util/TidiedDailyRollingFileAppender\$DatedFileFilter.class  net/sf/gratia/util/TidiedDailyRollingFileAppender.class"
        runit "cd -"

        logit "`ls -l /usr/share/tomcat5/common/classes/net/sf/gratia/util/`"
        logit "--- addining log4j.jar to common/lib"
        link=/usr/share/tomcat5/common/lib/log4j.jar
        runit "ln -s /usr/share/java/log4j.jar $link"
        logit "`ls -l $link`"
	;;
      "tomcat6" )  
	logit "--- Creating gratia-util links ---"
        dest=/usr/share/tomcat6/webapps/gratia-services/WEB-INF/lib/gratia-util.jar
        link=/usr/share/tomcat6/lib/gratia-util.jar
        if [ ! -f "$dest" ];then
                logerr "gratia-util file does not exist: $dest"
        fi
        if [ -f "$link" ];then
                logerr "Link or file already exists: $link"
        fi
        runit "ln -s $dest $link"
        logit "`ls -l $link`"
        logit "--- Creating links to /usr/share/java/slf4j/---"
        link=/usr/share/tomcat6/lib/slf4j-log4j12.jar
        runit "ln -s /usr/share/java/slf4j/log4j12.jar $link"
        logit "`ls -l $link`"
        link=/usr/share/tomcat6/lib/slf4j-api.jar
        runit "ln -s /usr/share/java/slf4j/api.jar $link"
        logit "`ls -l $link`"
	 ;;
        * ) logerr "This version of tomcat is not supported: $TOMCAT_VERSION" ;; 
    esac
    logit
}
#-------------------
function usage {
  echo "
Usage: $PGM 

Configures tomcat for a Gratia Collector RPM instance:
1. runs /var/lib/trustmanager-tomcat/configure.sh
2. sets up log jars
3. appends to the tomcat5/6.conf a new JAVA_OPTS 
4. creates a new server.xml from a template 
"
}
#### MAIN ############################################################
PGM=`basename $0`
BACKUP_DATE=`date +'%Y%m%d-%H%M'`
SERVER_XML_TEMPLATE=/usr/share/gratia/server.xml.template

logit "====== Configuring Tomcat for gratia ===="
verify_root
configuring_tomcat
handle_logging
update_tomcat_conf
update_server_xml
logit "====== Completed Tomcat configuration for Gatia ==="
exit 0
